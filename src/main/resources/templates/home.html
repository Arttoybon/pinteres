<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pint - Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        /* Transición suave para el cambio de color */
        body { background-color: #f8f9fa; transition: background-color 0.3s, color 0.3s; }
        
        .pin-card { border-radius: 16px; overflow: hidden; transition: transform 0.2s; border: none; }
        .pin-card:hover { transform: scale(1.02); cursor: pointer; }
        .pin-img { border-radius: 16px; width: 100%; height: auto; object-fit: cover; }
        
        /* --- ESTILOS MODAL TIPO PINTEREST --- */
        .modal-instagram .modal-dialog { max-width: 850px; }
        .modal-instagram .modal-content { border-radius: 32px; overflow: hidden; border: none; }
        .modal-container { display: flex; min-height: 500px; }
        
        .modal-image-side { 
            flex: 1.2; 
            background-color: #f0f0f0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            overflow: hidden;
            cursor: pointer;
        }
        .modal-image-side img { width: 100%; height: 100%; object-fit: cover; }
        .modal-info-side { flex: 1; background: white; padding: 32px; display: flex; flex-direction: column; }
        .user-avatar { width: 48px; height: 48px; background: #333; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 1.5rem; }

		@media (min-width: 768px) {
            .container-principal {
                padding-left: 100px !important;
            }
        }

        /* --- ESTILOS EXTRA PARA MODO OSCURO (NUEVO) --- */
        [data-bs-theme="dark"] body { background-color: #121212 !important; color: #f8f9fa; }
        [data-bs-theme="dark"] .modal-content { background-color: #1e1e1e; color: white; }
        [data-bs-theme="dark"] .modal-info-side { background-color: #1e1e1e; color: white; }
        [data-bs-theme="dark"] .text-dark { color: white !important; }
        [data-bs-theme="dark"] .bg-light { background-color: #2b2b2b !important; }
        [data-bs-theme="dark"] .pin-card { background-color: #1e1e1e; color: white; }
        [data-bs-theme="dark"] .card { background-color: #1e1e1e; }
        [data-bs-theme="dark"] .form-control { background-color: #2b2b2b; border-color: #444; color: white; }
        [data-bs-theme="dark"] .btn-light { background-color: #333; border-color: #444; color: white; }
        [data-bs-theme="dark"] .modal-image-side { background-color: #000 !important; }

        /* --- ANIMACIONES --- */
        @keyframes heartPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .pulse-animation { animation: heartPulse 0.3s ease-out; }

        .floating-heart {
            position: absolute;
            color: white;
            font-size: 5rem;
            opacity: 0;
            pointer-events: none;
            z-index: 10;
            text-shadow: 0 0 20px rgba(0,0,0,0.3);
            display: none; 
        }
        @keyframes heartIn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); opacity: 0.9; }
            100% { transform: scale(1); opacity: 0; }
        }
        .animate-heart { display: block !important; animation: heartIn 0.8s ease-out forwards; }
        
        #likeBtn { 
            width: 65px; height: 65px; 
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease;
            margin-bottom: -10px; 
            margin-right: -10px;
        }
        #likeBtn:active { transform: scale(0.9); }

        @media (max-width: 768px) {
            .modal-container { flex-direction: column; }
            .modal-image-side { height: 300px; }
        }
        .toast-container { z-index: 2000; }
    </style>
</head>
<body>

<div th:replace="~{navbar :: menuPrincipal}"></div>

<div class="container ps-3 ps-md-5" style="padding-left: 0;">
    <h2 class="fw-bold mb-4" th:text="${tituloPagina}"></h2>
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
        <div class="col" th:each="img : ${imagenes}">
            <div class="card pin-card shadow-sm btn-open-modal" 
                 th:data-id="${img.id}"
                 th:data-enlace="${img.enlace}" 
                 th:data-titulo="${img.titulo}" 
                 th:data-autor="${img.usuario.nombre}"
                 th:data-guardada="${imagenService.estaGuardado(img.id, session.usuarioLogueado.nombre)}">
                <img th:src="${img.enlace}" class="pin-img" th:alt="${img.titulo}">
                <div class="p-2">
                    <p class="small fw-bold m-0" th:text="${img.titulo}"></p>
                    <p class="text-muted mb-0" style="font-size: 0.75rem;">
                        <a th:href="@{/usuario/perfil/{nombre}(nombre=${img.usuario.nombre})}" 
                           th:text="'@' + ${img.usuario.nombre}" 
                           class="text-decoration-none text-muted fw-bold"
                           onclick="event.stopPropagation();"></a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade modal-instagram" id="pinDetailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-container">
                <div class="modal-image-side" id="modalImageContainer">
                    <i class="bi bi-heart-fill floating-heart" id="giantHeart"></i>
                    <img id="modalImg" src="" alt="">
                </div>
                <div class="modal-info-side">
                    <div class="d-flex justify-content-end mb-2">
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="d-flex align-items-center mb-4">
                        <div class="user-avatar"><i class="bi bi-pinterest"></i></div>
                        <div class="flex-grow-1">
                            <a id="linkPerfilModal" href="#" class="text-decoration-none text-dark">
                                <span class="fw-bold d-block" id="modalAutor">@autor</span>
                            </a>
                        </div>
                    </div>
                    <div class="bg-light p-3 rounded-4 mb-4">
                        <h3 id="modalTitulo" class="fw-bold h5 m-0">Título del Pin</h3>
                    </div>
                    <div class="mt-auto d-flex justify-content-end">
                        <button id="likeBtn" class="btn rounded-circle shadow-sm border p-0">
                            <i id="likeIcon" class="bi bi-heart fs-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Crear Pin</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form th:action="@{/publicar}" method="post">
                <div class="modal-body">
                    <div class="mb-3 text-start">
                        <label class="form-label small fw-bold">Título</label>
                        <input type="text" name="titulo" class="form-control rounded-pill" required>
                    </div>
                    <div class="mb-3 text-start">
                        <label class="form-label small fw-bold">URL de la imagen</label>
                        <input type="text" name="enlace" class="form-control rounded-pill" required>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="submit" class="btn btn-danger w-100 rounded-pill py-2 fw-bold">Publicar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="saveToast" class="toast align-items-center text-white bg-dark border-0 rounded-4" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-check-circle-fill text-success me-2"></i> 
                ¡Guardado en tus favoritos!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-toast="dismiss"></button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- LÓGICA MODO OSCURO (PERSISTENCIA) ---
        const htmlElement = document.documentElement;
        
        const aplicarTema = (tema) => {
            htmlElement.setAttribute('data-bs-theme', tema);
            const icon = document.getElementById('theme-icon');
            if(icon) {
                if(tema === 'dark') {
                    icon.classList.replace('bi-moon-fill', 'bi-sun-fill');
                    icon.classList.add('text-warning');
                } else {
                    icon.classList.replace('bi-sun-fill', 'bi-moon-fill');
                    icon.classList.remove('text-warning');
                }
            }
        };

        // Leer del localStorage al cargar
        const temaGuardado = localStorage.getItem('theme') || 'light';
        aplicarTema(temaGuardado);

        // El evento del botón se gestiona aquí o en el navbar (si el ID es 'theme-toggle')
        const btnToggle = document.getElementById('theme-toggle');
        if(btnToggle) {
            btnToggle.addEventListener('click', () => {
                const nuevoTema = htmlElement.getAttribute('data-bs-theme') === 'light' ? 'dark' : 'light';
                aplicarTema(nuevoTema);
                localStorage.setItem('theme', nuevoTema);
            });
        }

        // --- LÓGICA ORIGINAL DEL MODAL Y FAVORITOS ---
        const detailModal = new bootstrap.Modal(document.getElementById('pinDetailModal'));
        const saveToast = new bootstrap.Toast(document.getElementById('saveToast'));
        const cards = document.querySelectorAll('.btn-open-modal');
        const likeBtn = document.getElementById('likeBtn');
        const likeIcon = document.getElementById('likeIcon');
        const modalImageContainer = document.getElementById('modalImageContainer');
        const giantHeart = document.getElementById('giantHeart');
        
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        
        let currentId = null;

        function actualizarEstadoBoton(estaGuardado) {
            if (estaGuardado) {
                likeBtn.classList.remove('btn-light', 'text-danger');
                likeBtn.classList.add('btn-danger', 'text-white');
                likeIcon.classList.replace('bi-heart', 'bi-heart-fill');
                likeBtn.classList.remove('pulse-animation');
                void likeBtn.offsetWidth; 
                likeBtn.classList.add('pulse-animation');
            } else {
                likeBtn.classList.remove('btn-danger', 'text-white', 'pulse-animation');
                likeBtn.classList.add('btn-light', 'text-danger');
                likeIcon.classList.replace('bi-heart-fill', 'bi-heart');
            }
        }

        cards.forEach(card => {
            card.addEventListener('click', function() {
                currentId = this.getAttribute('data-id');
                const autor = this.getAttribute('data-autor');
                const guardado = this.getAttribute('data-guardada') === 'true';
                
                giantHeart.classList.remove('animate-heart');
                
                document.getElementById('modalImg').src = this.getAttribute('data-enlace');
                document.getElementById('modalTitulo').innerText = this.getAttribute('data-titulo');
                document.getElementById('modalAutor').innerText = '@' + autor;
                document.getElementById('linkPerfilModal').href = '/usuario/perfil/' + autor;

                actualizarEstadoBoton(guardado);
                detailModal.show();
            });
        });

        modalImageContainer.addEventListener('dblclick', function() {
            const cardOriginal = document.querySelector(`.pin-card[data-id="${currentId}"]`);
            if (cardOriginal.getAttribute('data-guardada') !== 'true') {
                likeBtn.click();
            }
            giantHeart.classList.remove('animate-heart');
            void giantHeart.offsetWidth; 
            giantHeart.classList.add('animate-heart');
            setTimeout(() => { giantHeart.classList.remove('animate-heart'); }, 800);
        });

        likeBtn.addEventListener('click', function() {
            if (!currentId) return;
            fetch('/like/' + currentId, { 
                method: 'POST',
                headers: { [csrfHeader]: csrfToken }
            })
            .then(response => response.json())
            .then(nuevoEstado => {
                actualizarEstadoBoton(nuevoEstado);
                const cardOriginal = document.querySelector(`.pin-card[data-id="${currentId}"]`);
                cardOriginal.setAttribute('data-guardada', nuevoEstado);
                if(nuevoEstado) saveToast.show();
            })
            .catch(err => console.error("Error:", err));
        });
    });
</script>
</body>
</html>